/* PRO-RESULT SYSTEM - B ✦ Gemini AI Collaboration */
let excelRows=[],subHeaders=[],currentDoc=null;const _0x5a2=v=>isNaN(v)||v==="AB"||v===""||v===null?v:String(v).padStart(2,'0');document.getElementById('excelFile').onchange=e=>{const f=e.target.files[0];if(!f)return;document.getElementById('fileName').textContent=f.name;const r=new FileReader();r.onload=ev=>{const d=new Uint8Array(ev.target.result);const w=XLSX.read(d,{type:'array'});const s=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});subHeaders=[];const h=s[0]||[];for(let i=2;i<h.length;i++){let t=String(h[i]||"").trim().toUpperCase();if(["TOTAL","PER","RESULT","RANK"].includes(t))break;subHeaders.push(h[i]||`Sub-${i-1}`)}excelRows=s.slice(1).filter(x=>x[1]);document.getElementById('status-tick').style.display='inline';document.getElementById('viewBtn').style.display='inline-block'};r.readAsArrayBuffer(f)};function generatePDF(){const{jsPDF:j}=window.jspdf;const d=new j('p','cm','a4');if(!excelRows||excelRows.length===0)return null;const m=parseFloat(document.getElementById('maxM').value)||50;const p=Math.round(m*0.33);let pr=excelRows.map(o=>{let mk=[],tn=0,fc=0,as=0,ab=false;for(let i=0;i<subHeaders.length;i++){let v=o[i+2],s=String(v|| "").trim().toUpperCase();if(s==='AB'){mk.push("AB");ab=true}else{let n=parseFloat(v);if(!isNaN(n)){mk.push(_0x5a2(n));tn+=n;as++;if(n<p)fc++}else mk.push("")}}let pe=(as>0?(tn/(as*m)*100).toFixed(1):"0.0")+" %";return{roll:o[0],name:o[1],marks:mk,totalStr:ab?"AB":String(tn).padStart(3,'0'),perStr:ab?"AB":pe,res:ab?"Ab..":(fc>0?`Fail-${fc}`:"Pass"),totalNum:ab?-1:tn}});let pa=[...pr].filter(x=>x.res==="Pass").sort((a,b)=>b.totalNum - a.totalNum);pr.forEach(r=>{r.rank=(r.res==="Pass")?_0x5a2(pa.findIndex(x=>x.roll===r.roll)+1):""});const rW=0.7,nW=4.2,sW=1.0,tW=4.5;const tT=rW+nW+(subHeaders.length*sW)+tW;const dL=1.2,rE=dL+tT,tC=dL+(tT/2);const tB=[['','(Passing Marks)-->',...Array(subHeaders.length).fill(p),'','','',''],...pr.map(x=>[x.roll,x.name,...x.marks,x.totalStr,x.perStr,x.res,x.rank])];d.autoTable({startY:4.2,margin:{top:4.2,left:dL,bottom:1.5},tableWidth:tT,theme:'grid',body:tB,styles:{font:'helvetica',fontSize:9,halign:'center',cellPadding:0.1,lineWidth:0.01},columnStyles:{0:{cellWidth:rW},1:{cellWidth:nW,halign:'left',overflow:'ellipsize'},[2+subHeaders.length]:{cellWidth:1.2},[3+subHeaders.length]:{cellWidth:1.4},[4+subHeaders.length]:{cellWidth:1.0},[5+subHeaders.length]:{cellWidth:0.9}},didDrawPage:da=>{const pdf=da.doc;pdf.setDrawColor(0);pdf.setLineWidth(0.01);pdf.rect(dL,2.1,tT,2.1);pdf.setFont("helvetica","bold");pdf.setFontSize(14);pdf.text(document.getElementById('school').value,tC,0.9,{align:'center'});pdf.setFontSize(10);pdf.text(document.getElementById('exam').value+": "+document.getElementById('className').value,dL,1.6);pdf.text(document.getElementById('dateInput').value,tC,1.6,{align:'center'});pdf.text("Max Marks: "+m,rE,1.6,{align:'right'});pdf.setFontSize(9);const sX=dL+rW+nW+(sW/2);pdf.saveGraphicsState();pdf.text("Roll No",dL+0.4,4.0,{angle:90});pdf.restoreGraphicsState();pdf.text("Student's Name",dL+0.9,4.0);for(let i=0;i<subHeaders.length;i++){pdf.saveGraphicsState();pdf.text(subHeaders[i],sX+(i*sW),4.0,{angle:90});pdf.restoreGraphicsState()}const tL=["Rank","Result","Per %","Total"],tS=[0.9,1.0,1.4,1.2];let cR=rE;for(let j=0;j<4;j++){pdf.saveGraphicsState();pdf.text(tL[j],cR-(tS[j]/2)+0.05,4.0,{angle:90});pdf.restoreGraphicsState();cR-=tS[j]}
        
        /* --- PLAIN TEXT SIGNATURE & DEDICATION --- */
        pdf.setFontSize(7);
        pdf.setTextColor(150);
        pdf.setFont("helvetica", "italic");
        const ded = "શિક્ષકોના સમયનું સન્માન, પરિણામમાં ચોકસાઈનું પ્રમાણ.";
        pdf.text(ded, dL, 28.7);
        const sig = "B ✦ Gemini AI Collaboration | Pro-Result System v1.0";
        pdf.text(sig, rE - pdf.getTextWidth(sig), 28.7);
    }});
    return d
}
window.updatePreview=()=>{currentDoc=generatePDF();document.getElementById('pdfPreview').src=currentDoc.output('bloburl');document.getElementById('preview-container').style.display='block';document.getElementById('downloadBtn').style.display='inline-block'};window.downloadPDF=()=>{if(currentDoc)currentDoc.save('Marksheet.pdf')};
